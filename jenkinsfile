pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                // Clone the repository
                checkout scm
            }
        }
        stage('Build') {
            steps {
                // Clean and build the project using Maven
                bat 'mvn clean install'
            }
        }
        stage('Start Application with Java Agent') {
            steps {
                // Start the application with JaCoCo Java agent
                bat 'java -javaagent:src\\main\\resources\\jacocoagent.jar=address=*,port=6300,destfile=jacoco-it.exec,output=tcpserver -jar target\\maven-jacoco-dump-demo-0.0.1-SNAPSHOT.jar'
            }
        }
        stage('Execute Karate Test Suites') {
            steps {
                // Add your command to execute Karate tests (adjust this as needed)
                bat 'mvn test -Dtest=KarateTest' // Example: Modify based on your setup
            }
        }
        stage('Dump JaCoCo Coverage Data') {
            steps {
                // Dump JaCoCo coverage data from the running application
                bat 'java -jar src\\main\\resources\\jacococli.jar dump --address localhost --port 6300 --destfile target\\jacoco-it.exec'
            }
        }
        stage('Generate JaCoCo Coverage Report') {
            steps {
                // Generate JaCoCo report
                bat 'java -jar src\\main\\resources\\jacococli.jar report target\\jacoco-it.exec --classfiles target\\classes\\com --sourcefiles src\\main\\java\\ --html target\\jacoco-report'
            }
        }
    }
}
