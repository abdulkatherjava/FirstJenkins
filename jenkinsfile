node {
    // Define variables
    def jacocoAgentJar = "src\\main\\resources\\jacocoagent.jar"
    def jacocoCliJar = "src\\main\\resources\\jacococli.jar"
    def jacocoExecFile = "target\\jacoco-it.exec"
    def jacocoReportDir = "target\\jacoco-report"
    def appJar = "target\\maven-jacoco-dump-demo-0.0.1-SNAPSHOT.jar"
//     def karateTestsDir = "path\\to\\karate\\tests" // Update with your actual path
    def port = "6300"

    try {
        stage('Start Application with JaCoCo Agent') {
            echo 'Starting Spring Boot application with JaCoCo agent...'
            bat """
                start java -javaagent:${jacocoAgentJar}=address=*,port=${port},destfile=${jacocoExecFile},output=tcpserver ^
                -jar ${appJar}
            """
            echo 'Waiting for application to start...'
            sleep(15) // Wait for the app to start
        }

        stage('Dump JaCoCo Execution Data') {
            echo 'Dumping JaCoCo execution data...'
            bat """
                java -jar ${jacocoCliJar} dump --address localhost --port ${port} --destfile ${jacocoExecFile}
            """
        }

        stage('Generate JaCoCo Report') {
            echo 'Generating JaCoCo report...'
            bat """
                java -jar ${jacocoCliJar} report ${jacocoExecFile} ^
                --classfiles target\\classes\\com ^
                --sourcefiles src\\main\\java\\ ^
                --html ${jacocoReportDir}
            """
        }
    } finally {
        stage('Cleanup') {
            echo 'Cleaning up application process...'
            bat "taskkill /F /IM java.exe /T || exit 0"
        }
    }
}
