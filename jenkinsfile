node {
    // Define variables
    def jacocoAgentJar = "src\\main\\resources\\jacocoagent.jar"
    def jacocoCliJar = "src\\main\\resources\\jacococli.jar"
    def jacocoExecFile = "target\\jacoco-it.exec"
    def jacocoReportDir = "target\\jacoco-report"
    def appJar = "target\\maven-jacoco-dump-demo-0.0.1-SNAPSHOT.jar"
    def port = "6300"

    try {
        stage('Checkout') {
            checkout scm
            // Or specify the repository explicitly
            git url: 'https://github.com/abdulkatherjava/FirstJenkins.git', branch: 'master'
        }

        stage('Build') {
            echo 'Building the project...'
            bat 'mvn clean package'
        }

        stage('Start Application with JaCoCo Agent') {
            echo 'Starting Spring Boot application with JaCoCo agent...'
            bat """
                java -javaagent:${jacocoAgentJar}=address=*,port=${port},destfile=${jacocoExecFile},output=tcpserver -jar ${appJar}
            """
            echo 'Waiting for application to start...'
            sleep(20) // Wait longer or use a health-check mechanism
        }

        stage('Dump JaCoCo Execution Data') {
            echo 'Dumping JaCoCo execution data...'
            bat """
                java -jar ${jacocoCliJar} dump --address localhost --port ${port} --destfile ${jacocoExecFile}
            """
        }

        stage('Generate JaCoCo Report') {
            echo 'Generating JaCoCo report...'
            bat """
                java -jar ${jacocoCliJar} report ${jacocoExecFile} ^
                --classfiles target\\classes ^
                --sourcefiles src\\main\\java ^
                --html ${jacocoReportDir}
            """
        }
    } catch (err) {
        echo "Pipeline failed with error: ${err}"
        throw err // Ensure the build fails
    } finally {
        echo 'Pipeline finished.'
    }
}
