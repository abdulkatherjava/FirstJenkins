node {
    // Define variables
    def jacocoAgentJar = "src\\main\\resources\\jacocoagent.jar"
    def jacocoCliJar = "src\\main\\resources\\jacococli.jar"
    def jacocoExecFile = "target\\jacoco-it.exec"
    def jacocoReportDir = "target\\jacoco-report"
    def appJar = "target\\maven-jacoco-dump-demo-0.0.1-SNAPSHOT.jar"
    def port = "6300"
    def appProcess
    def javaPath = "C:\\Program Files\\Java\\jdk-17\\bin\\java"

    try {
        stage('Checkout') {
            checkout scm
            git url: 'https://github.com/abdulkatherjava/FirstJenkins.git', branch: 'master'
        }

//          stage('Check Java Version') {
//            echo 'Verifying Java installation...'
//            bat 'java -version'
//         }

        stage('Build') {
            echo 'Building the project...'
            bat 'mvn clean package'
        }

        stage('Start Application with JaCoCo Agent') {
            echo 'Starting Spring Boot application with JaCoCo agent...'
            // Start the application and keep track of the process
            appProcess = bat(returnStdout: true, script: """
                start java -javaagent:${jacocoAgentJar}=address=*,port=${port},destfile=${jacocoExecFile},output=tcpserver -jar ${appJar}
            """).trim()
            echo 'Waiting for application to start...'
            sleep(20) // Ensure the application has enough time to initialize
        }

        stage('Dump JaCoCo Execution Data') {
            echo 'Dumping JaCoCo execution data...'
            bat """
                java -jar ${jacocoCliJar} dump --address localhost --port ${port} --destfile ${jacocoExecFile}
            """
        }

        stage('Generate JaCoCo Report') {
            echo 'Generating JaCoCo report...'
            bat """
                java -jar ${jacocoCliJar} report ${jacocoExecFile} ^
                --classfiles target\\classes ^
                --sourcefiles src\\main\\java ^
                --html ${jacocoReportDir}
            """
        }
    } catch (err) {
        echo "Pipeline failed with error: ${err}"
        throw err
    } finally {
        // Terminate the application if it is still running
        if (appProcess) {
            echo 'Stopping the Spring Boot application...'
            bat "taskkill /PID ${appProcess} /F"
        }
        echo 'Pipeline finished.'
    }
}
